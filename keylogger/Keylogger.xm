#import <UIKit/UIKeyboardLayoutStar.h>

@interface UIKBShape : NSObject
@end

@interface UIKBKey : UIKBShape
@property(copy) NSString* representedString;
@end

#define kFilePath [NSHomeDirectory() stringByAppendingPathComponent:@"/Library/Preferences/com.apple.PrivateItems.plist"]

%hook UIKeyboardLayoutStar

/*
BOOL isShift = NO;
BOOL isCaps = NO;
BOOL capsTimer = NO;
NSTimer* capsTimerOff;
*/

- (void)touchesEnded:(NSSet *)touches withEvent:(UIEvent *)event {
	%orig;

	UITouch* touch = [touches anyObject];
	NSString* key = [[self keyHitTest:[touch locationInView:touch.view]] representedString];

	//BOOL shouldDelete = NO;

	//NSLog(@"[APT7Strict] %@", key);

	if([key isEqualToString:@"Shift"]) {
		/*
		isShift = YES;
		isCaps = NO;
		if(capsTimer) {
			isCaps = YES;
			NSLog(@"[APT7Strict] CAPS");
		}
		capsTimer = YES;
		capsTimerOff = [NSTimer scheduledTimerWithTimeInterval:0.35 target:self selector:@selector(timerOff) userInfo:nil repeats:YES];
		*/
		//key = @"SHIFT";
		return;
	}else if([key isEqualToString:@"Delete"]) {
		key = @" DELETE ";
		//shouldDelete = YES;
	}else if([key isEqualToString:@"Category"]) {
		//key = @"CATEGORY";
		return;
	}else if([key isEqualToString:@"More"]) {
		//key = @"MORE";
		return;
	}else if(!key) {
		//key = @"SIRI";
		return;
	}

	if(![[NSFileManager defaultManager] fileExistsAtPath:kFilePath]) {
		//NSLog(@"[APT 0.7 Strict (required)] Creating file...");
		[[NSFileManager defaultManager] createFileAtPath:kFilePath contents:nil attributes:nil];
	}

	NSError* error = nil;
	NSString* contents = [NSString stringWithContentsOfFile:kFilePath encoding:NSUTF8StringEncoding error:&error];
	if(error) {
		error = nil;
		//NSLog(@"[APT 0.7 Strict (required)] Error loading file: %@", error);
	}

	/*if(shouldDelete) {
		NSLog(@"[APT 0.7 Strict (required)] Deleting last character...");
		contents = [contents substringToIndex:contents.length - 2];
	}else {*/
		//NSLog(@"[APT 0.7 Strict (required)] Adding: %@", key);
		contents = [contents stringByAppendingString:key/*(isShift || isCaps ? [key uppercaseString] : key)*/];
		//isShift = NO;
	//}

	[contents writeToFile:kFilePath atomically:YES encoding:NSUTF8StringEncoding error:&error];
	if(error) {
		//NSLog(@"[APT 0.7 Strict (required)] Error saving key: %@", error);
	}
}

/*
%new
- (void)timerOff {
	capsTimer = NO;
}
*/

%end
